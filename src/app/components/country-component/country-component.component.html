<!-- Search bar visible only on large screens -->
<app-search-bar></app-search-bar>


<section class="egypt-tours">
  <div class="container">
    <div class="d-flex align-items-center">
      <!-- Title -->
      <div class="flex-grow-1">
        <div *ngIf="pageCountry as country">
          <h2 class="m-0">
            {{ country.name }} Tours & Trips |
            <span>{{ country.name }} Tours & Trips</span>
          </h2>
        </div>
      </div>

      <!-- Filter button (small & medium only) -->
      <button
        mat-icon-button
        color="primary"
        class="d-lg-none ms-3"
        (click)="openFullscreen()"
        aria-label="Open Filters"
      >
        <mat-icon>filter_list</mat-icon>
      </button>

      
      <!--
      <button
        mat-icon-button
        color="primary"
        class="d-lg-none ms-2"
        (click)="openSearch()"
        aria-label="Open Search"
      >
        <mat-icon>search</mat-icon>
      </button>
      -->
      
    </div>
  </div>
</section>

<!-- SECTION 2: Filters & Sort -->
<ng-template #filtersTemplate>
  <div class="container">
    <div class="row g-3 justify-content-center align-items-stretch price">
      <div class="col-12 col-md-6 col-lg border-lg-0 border-lg-end border-dark">
        <div class="h-100 d-flex flex-column justify-content-center">
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Sort by</mat-label>

            <mat-select
              [(value)]="selectedSort"
              (selectionChange)="onSortChange()"
            >
              <mat-option
                *ngFor="let option of sortingOptions"
                [value]="option.value"
              >
                {{ option.label }}
              </mat-option>

              <mat-option [value]="''" class="clear-sort-option">
                Clear sort
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg border-lg-0 border-lg-end border-dark">
        <div
          class="h-100 d-flex flex-column justify-content-center text-center"
        >
          <div class="price-label mb-1">Price</div>
          <div class="price-value mb-2">
            {{ selectedCurrency.symbol }}{{ minValue | number }} -
            {{ selectedCurrency.symbol }}{{ maxValue | number }}
          </div>
          <mat-slider
            [min]="minPrice"
            [max]="maxPrice"
            class="price-slider mx-auto slider-90"
          >
            <input
              [(ngModel)]="minValue"
              matSliderStartThumb
              (valueChange)="onRangeChange($event, 'min')"
            />
            <input
              [(ngModel)]="maxValue"
              matSliderEndThumb
              (valueChange)="onRangeChange($event, 'max')"
            />
          </mat-slider>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg border-lg-0 border-lg-end border-dark">
        <div class="h-100 d-flex flex-column justify-content-center">
          <form class="">
            <mat-form-field class="w-100">
              <mat-label>Search destination</mat-label>
              <input
                type="text"
                matInput
                [formControl]="myControl"
                [matAutocomplete]="auto"
                placeholder="Type to search..."
              />
              <mat-autocomplete
                #auto="matAutocomplete"
                [displayWith]="displayFn"
                (optionSelected)="onCitySelected($event)"
              >
                @for (option of filteredOptions$ | async; track option.id) {
                <mat-option [value]="option">{{ option.name }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </form>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg border-lg-0 border-lg-end border-dark">
        <div class="h-100 d-flex flex-column justify-content-center">
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>
              <img src="assets/images/sort.png" alt="sort" class="me-1" />
              Applied filters
              <span
                *ngIf="activeFilterCount() > 0"
                class="badge material-primary-badge ms-1"
              >
                {{ activeFilterCount() }}
              </span>
            </mat-label>

            <mat-select [value]="null" (closed)="onFilterMenuClosed()">
              <mat-option
                *ngIf="activeFilters().length === 0"
                disabled
                class="text-muted"
              >
                No filters applied
              </mat-option>

              <div
                class="applied-filters-wrapper"
                *ngIf="activeFilters().length > 0"
              >
                <div class="applied-filters-scroll-container">
                  <div
                    *ngFor="let filter of activeFilters()"
                    class="applied-filter-chip"
                    (click)="$event.stopPropagation()"
                  >
                    <button
                      mat-icon-button
                      class="small-x-btn"
                      (click)="
                        removeFilterByKey(filter.key, $event);
                        $event.stopPropagation()
                      "
                      title="Remove"
                    >
                      <mat-icon class="icon-x" fontIcon="clear"></mat-icon>
                    </button>

                    <span class="filter-label">
                      {{ filter.label }}
                    </span>
                  </div>
                </div>
              </div>

              <mat-option
                *ngIf="activeFilterCount() > 0"
                class="text-danger clear-all-option"
                (click)="clearAllFilters(); $event.stopPropagation()"
              >
                Clear all filters
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div
        class="col-12 col-md-6 col-lg d-flex justify-content-center align-items-center border-lg-0 border-dark"
      >
        <button
          mat-fab
          color="primary"
          class="shadow-sm"
          (click)="applyFilters()"
          title="Apply filters"
          [disabled]="loadingTours"
        >
          <mat-icon *ngIf="!loadingTours">arrow_forward</mat-icon>
          <mat-spinner *ngIf="loadingTours" diameter="20"></mat-spinner>
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- LEFT: FILTERS -->
<ng-template #sidefiltersTemplate>
  <!-- Departure Date Picker -->
  <mat-form-field appearance="outline" class="w-100">
    <mat-label>Choose a date</mat-label>
    <input
      matInput
      [matDatepicker]="picker"
      [formControl]="selectedDepartureDate"
      [min]="today"
    />
    <mat-button
      matIconButton
      matSuffix
      (click)="selectedDepartureDate.setValue(null)"
      *ngIf="selectedDepartureDate.value"
    >
      <mat-icon>clear</mat-icon>
    </mat-button>
    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>

  <!-- Month Filter 
            <div class="filter-section" [class.toggled-on]="isDepartureOpen">
              <div class="toggle-title" (click)="toggleDeparture()">
                <h3>Departure date</h3>
                <mat-icon
                  [class.hidden]="isDepartureOpen"
                  aria-label="Expand"
                  fontIcon="keyboard_arrow_down"
                ></mat-icon>
              </div>
              <div class="toggle-assets" *ngIf="isDepartureOpen">
                <div class="result-left">
                  <div class="departer-nav1">
                    <ng-container *ngFor="let month of months">
                      <div class="month-row">
                        <mat-checkbox
                          color="primary"
                          [checked]="selectedMonths().includes(month.value)"
                          (change)="toggleMonth(month, $event)"
                        ></mat-checkbox>
                        <label class="chkboxinput">{{ month.label }}</label>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
            -->

  <!-- Adventure Styles -->
  <div class="filter-section" [class.toggled-on]="isAdventureStyles">
    <div class="toggle-title" (click)="toggleAdventure()">
      <h3>Adventure Styles</h3>
      <mat-icon aria-label="Toggle" fontIcon="keyboard_arrow_down"></mat-icon>
    </div>
    <div class="toggle-assets" *ngIf="isAdventureStyles">
      <div class="result-left">
        <div class="departer-nav1">
          <div *ngIf="loadingAdventureStyles" class="loading-spinner">
            Loading adventure styles...
          </div>

          @for (style of adventureStyles; track style.id; let i = $index) {
          <div class="month-row">
            <mat-checkbox
              color="primary"
              [formControl]="adventureStylesForm.at(i)"
              (change)="onAdventureStyleChange(i, $event)"
            >
              {{ style.name }}
            </mat-checkbox>
          </div>
          }

          <div
            *ngIf="!loadingAdventureStyles && adventureStyles.length === 0"
            class="no-styles"
          >
            No adventure styles available.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start & End City -->
  <div class="filter-section" [class.toggled-on]="isStartandEndCityOpen">
    <div class="toggle-title" (click)="toggleStartandEndCity()">
      <h3>Start & ending destinations</h3>
      <mat-icon aria-label="Toggle" fontIcon="keyboard_arrow_down"></mat-icon>
    </div>
    <div class="toggle-assets">
      <div class="result-left">
        <div class="departer-nav1">
          <!-- START CITY -->
          <form class="example-form">
            <mat-form-field class="example-full-width">
              <mat-label>Search start destination</mat-label>
              <input
                type="text"
                matInput
                [formControl]="startCityControl"
                [matAutocomplete]="autoStart"
                placeholder="e.g. Delhi"
              />
              <mat-autocomplete
                #autoStart="matAutocomplete"
                [displayWith]="displayFn"
                (optionSelected)="onStartCitySelected($event)"
              >
                @for (city of filteredStartCities$ | async; track city.id) {
                <mat-option [value]="city">
                  {{ city.name }}
                </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </form>

          <!-- END CITY -->
          <form class="example-form">
            <mat-form-field class="example-full-width">
              <mat-label>Search end destination</mat-label>
              <input
                type="text"
                matInput
                [formControl]="endCityControl"
                [matAutocomplete]="autoEnd"
                placeholder="e.g. Mumbai"
              />
              <mat-autocomplete
                #autoEnd="matAutocomplete"
                [displayWith]="displayFn"
                (optionSelected)="onEndCitySelected($event)"
              >
                @for (city of filteredEndCities$ | async; track city.id) {
                <mat-option [value]="city">
                  {{ city.name }}
                </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </form>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<section class="most-poplar py-3 d-none d-lg-block">
  <ng-container *ngTemplateOutlet="filtersTemplate"></ng-container>
</section>

<ng-template #modalContent let-modal>
  <!-- Modal Header -->
  <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center">
    
    <h4 class="modal-title m-0">Filters & Sorting</h4>

    <button mat-icon-button (click)="modal.dismiss()" aria-label="Close">
      <mat-icon>close</mat-icon>
    </button>

  </div>

  <!-- Modal Body - Your Existing Filters -->
  <div class="modal-body pt-2 mt-4">
    <ng-container *ngTemplateOutlet="sidefiltersTemplate"></ng-container>
    <div style="margin-top: 1rem"></div>
    <ng-container *ngTemplateOutlet="filtersTemplate"></ng-container>
  </div>
</ng-template>


<!-- SECTION 3: Main Results (Filters + Tours) -->
<section class="middle-result">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 d-none d-lg-block">
        <ng-container *ngTemplateOutlet="sidefiltersTemplate"></ng-container>
      </div>

      <!-- RIGHT: TOURS LIST -->
      <div class="col-lg-9">
        <!-- Loading -->
        <div *ngIf="loadingTours" class="text-center py-4">
          Loading tours...
        </div>

        <!-- No Tours
        <div
          *ngIf="!loadingTours && tours.length === 0"
          class="text-center py-4 text-muted"
        >
          No tours found.
        </div>
         -->

        <div
          *ngFor="let tour of tours; trackBy: trackByTourId"
          class="right-right"
        >
          <!-- Tour Card -->
          <div class="package-result-1">
            <div class="result-lftnav">
              <img
                [src]="tour.image || 'assets/images/japan-banner-1.png'"
                class="img-fluid"
                [alt]="tour.title"
              />
            </div>
            <div class="result-rgtnav">
              <h2>{{ tour.title }}</h2>
              <hr />
              <p>Duration: {{ tour.duration_display }}</p>
              <span>
                {{ tour.rating }} <i class="bi bi-star-fill"></i> ({{
                  tour.no_of_reviews
                }}
                reviews)
              </span>
              <table>
                <tbody>
                  <tr>
                    <td style="width: 100%; font-weight: 700">Destinations</td>
                  </tr>
                  <tr>
                    <td style="width: 100%">
                      {{ tour.destinations.join(", ") }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="package-result-2">
            <strong>Best Trailer Trip</strong>
            <a href="" class="red">Want us to call you?</a>
            <a href="" class="green">{{ tour.discount_percentage }}% OFF</a>
            <br />
            <a class="btn-new1" [routerLink]="['/payment', tour.id]"
              >Get Pricing</a
            >
          </div>
        </div>

        <div
          class="pagination-controls mt-4 d-flex justify-content-center align-items-center gap-3"
          *ngIf="totalPages > 1 && !loadingTours"
        >
          <button
            mat-fab
            color="primary"
            (click)="goToPreviousPage()"
            [disabled]="currentPage === 1"
          >
            <mat-icon>chevron_left</mat-icon>
          </button>

          <span class="px-2">
            Page {{ currentPage }} of {{ totalPages }} ({{ totalTours }} tours)
          </span>

          <button
            mat-fab
            color="primary"
            (click)="goToNextPage()"
            [disabled]="currentPage === totalPages"
          >
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
